全局约束
Solidity ≥0.8
禁止使用 tx.origin
禁止未限制的 delegatecall
所有敏感操作必须权限控制
所有外部输入默认不可信
状态修改必须先于外部调用
禁止单EOA控制核心权限

权限控制
检测项：
是否存在未加权限的敏感函数
upgrade
mint
burn
pause
setOracle
setAdmin
规则：
必须使用 role 或 multisig
禁止 owner 与 role 混用
admin 必须支持迁移
高权限操作建议存在 timelock
风险等级：
未授权敏感函数 → critical
单EOA admin → high

Reentrancy
检测模式：
external call 后存在 storage 写入
高危函数类型：
withdraw
claim
borrow
liquidate
规则：
必须遵守 checks → effects → interactions
必须使用 reentrancy guard 或 pull payment
风险等级：
可重入提款 → critical
可重入状态修改 → high

整数安全
检测项：
是否存在 unchecked 块
是否存在自定义数学库
规则：
默认依赖 solidity 0.8 overflow 检查
unchecked 必须仅用于可证明安全的场景
风险等级：
可导致资产错误计算 → critical

Oracle依赖
检测项：
是否直接读取 AMM spot price
是否缺失价格有效期校验
是否依赖单一oracle
规则：
必须校验
price > 0
updatedAt 在允许窗口内
推荐使用 TWAP 或聚合oracle
风险等级：
可被瞬时价格操控 → critical

Flash Loan可利用性
检测路径：
单交易内是否可改变关键状态
price
governance weight
collateral ratio
reserves
规则：
必须存在滑点或边界检查
必须存在协议级 invariant
示例 invariant 类型：
totalCollateral ≥ totalDebt
reserves ≥ liabilities
风险等级：
可单交易获利 → critical

Upgrade / Proxy
检测项：
initializer 是否可重复调用
admin 是否单点
storage layout 是否存在冲突风险
规则：
initializer 必须锁定
admin 必须 multisig
推荐 timelock
风险等级：
未初始化代理 → critical
单点升级 → high

External Call风险
检测项：
call
delegatecall
staticcall
与未知token交互
规则：
外部调用后不得修改关键状态
必须检查返回值
禁止假设 token 符合标准
风险等级：
状态依赖外部返回 → high

状态一致性
检测项：
是否存在可破坏偿付能力的路径
核心不变量：
solvency
collateralization
supply一致性
规则：
必须定义协议级 invariant
必须支持 fuzz / invariant 测试
风险等级：
可导致资不抵债 → critical

重复发现去重语义
同一 root cause 归并条件：
相同状态变量
相同权限缺陷
相同价格源
相同external call路径
避免按函数级重复计数。

Severity判定基准
Critical
可直接窃取资金
可冻结资金
可破坏偿付能力
可接管协议
可单交易套利
High
权限错误
可升级滥用
高概率经济攻击
可大规模资金损失
Medium
拒绝服务
风险配置错误
依赖中心化组件
Low
可读性
非关键事件缺失
非关键gas问题

Time-to-Signal优化约束
优先扫描：
权限
external call
oracle
collateral逻辑
upgrade路径
降低深层路径搜索优先级。

Precision约束
禁止报告：
仅理论不可执行路径
需要不现实前提的攻击
已被权限完全阻断的路径
必须包含：
攻击前置条件
可执行路径
影响资产类型

Recall增强策略
必须覆盖：
所有资金流函数
所有权限边界
所有价格依赖
所有状态转换
不得跳过：
internal函数
library调用
proxy逻辑

Exploit可能性评分输入
评估维度：
攻击成本
所需权限
流动性需求
是否可原子执行
自动化可行性
输出：
exploitable
likely exploitable
theoretical

计算优先级策略
最高优先级目标：
资金安全
偿付能力
权限控制
低优先级：
gas
风格
非安全重构

禁止行为
不得基于命名假设安全性
不得信任注释
不得假设外部协议安全
不得忽略经济攻击路径
